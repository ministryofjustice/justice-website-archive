<div align="center">

<a id="readme-top"></a>

<br>

<img alt="MoJ logo" src="https://moj-logos.s3.eu-west-2.amazonaws.com/moj-uk-logo.png" width="200">

# www.justice.gov.uk <br>Archiver

<br>

[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fjustice-website-archive&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-report/justice-website-archive)
[![License](https://img.shields.io/github/license/ministryofjustice/justice-website-archive?style=for-the-badge)](https://github.com/ministryofjustice/justice-website-archive/blob/main/LICENSE)

[![CI and CD](https://github.com/ministryofjustice/justice-website-archive/actions/workflows/cd.yml/badge.svg)](https://github.com/ministryofjustice/justice-website-archive/actions/workflows/cd.yml)

</div>

### Table of contents
<details open="open">
<summary><b>(click to expand or hide)</b></summary>

1. [Workflow](#workflow)
2. [Viewing the latest snapshot](#viewing-the-latest-snapshot)
3. [Creating a snapshot](#creating-a-snapshot)
4. [Local development](#local-development)
   1. [Installation](#installation)
   2. [Understanding application logic](#understanding-application-logic)
5. [HTTrack](#httrack)
   1. [Debugging](#debugging)
   2. [Testing and making modifications](#testing-and-making-modifications)
6. [Kubernetes](#kubernetes)
   1. [Commands](#useful-commands)
7. [Makefile](#makefile)
   1. [Commands](#make-commands)

</details>

---

## Workflow

Archive utility to capture working snapshots of justice.gov.uk. We use the following technologies to achieve this:

1. Cloud Platform
2. AWS S3
3. AWS CloudFront
4. HTTrack Cli
5. NodeJS Server

<a id="viewing-the-latest-snapshot"></a>
## Viewing the latest snapshot

Access point:

## [Archive: justice.gov.uk](https://dnaspuf4vt4nd.cloudfront.net/www.justice.gov.uk/index.html)

<br><br> [back to top](#readme-top)

## Creating a snapshot

Access is granted if you are in possession of our basic-auth credentials; these are different from the credentials 
mentioned above.

Access point for `archive-user`: [Cloud Platform](https://justice-archiver.apps.live.cloud-platform.service.justice.gov.uk/)


## Local development

> It's important to note that creating a snapshot from a local machine proved to present resource
> related issues, such as rate limiting. 

Requires

- Docker


### Installation

Clone to your machine:

```
git clone https://github.com/ministryofjustice/justice-website-archive.git && cd justice-website-archive
```

Start docker compose:

```
make run
```

There is a script designed to help you install the [Dory Proxy](https://github.com/FreedomBen/dory), if you'd like to.

If you chose to install Dory, you can access the application here:

[http://spider.justice.docker/](http://spider.justice.docker/)

Otherwise, access the application here:

[http://localhost:8080/](http://localhost:8080/)

<br><br> [back to top](#readme-top)

## Understanding application logic

Let's begin with servers and their interactions within... 

The Archiver has an Nginx server. This is used to display responses from the underlying NodeJS 
server where Node processes form requests and decides how to treat them.

Essentially, if happy with the request, Node will instruct HTTrack to perform a website copy operation, and it does this 
with predefined options. 

Supercronic is used within the app for scheduling. We have two schedules defined:

1. S3 data-sync
2. Daily snapshot

### S3 data-sync
Using the AWS Cli, our data-sync executes `aws s3 sync /snapshot/ s3://our-bucket` every 6 minutes whilst a spider 
operation is alive. When the operation completes, the schedule is cancelled. A last and final data-sync takes place to
ensure all snapshot data has been transferred.

### Daily snapshot
At 3 am each morning, a snapshot process is launched by sending an authorised POST request to the node service. Once
accepted, S3 data-sync is scheduled; S3 data-sync only runs during a snapshot process.  


<br><br> [back to top](#readme-top)
## HTTrack

At the very heart of the Archiver sits [HTTrack](https://en.wikipedia.org/wiki/HTTrack). This application is configured 
by Node to take a snapshot of the MoJ Intranet. Potentially, you can point the Archiver at any website address and, 
using the settings for the Intranet, it will attempt to create an isolated copy of it.

### Debugging

The output of HTTrack can be noted in Docker Composes' `stdout` in the running terminal window however, a more 
detailed and linear output stream is available in the `hts-log.txt` file. You can find this in the root of the snapshot. 

### Testing and making modifications

All application processing for HTTrack is managed in the `process.js` file located in the NodeJS application. You will find all the 
options used to set HTTrack up.

To understand the build process further, please look at the Makefile.

<br><br> [back to top](#readme-top)

## Kubernetes
 
[Interact with running pods with help from this cheatsheet](https://kubernetes.io/docs/reference/kubectl/cheatsheet/#interacting-with-running-pods).
Please be aware that with every call to the CP k8s cluster, you will need to provide the namespace, as shown below:

```bash
kubectl -n justice-website-archive-dev
```

### Useful commands

```bash
# list available pods for the namespace
kubectl get pods --namespace justice-gov-uk-archiver-dev

# make interaction a little easier; we can create repeatable variables
# our namespace is the same name as the app, defined in ./kubectl_deploy/development/deployment.tpl
# K8S_NSP="justice-gov-uk-archiver-dev";

# define a pod name, gets the first available pod
# K8S_POD=$(kubectl -n ${K8S_NSP} get pod -l app=${K8S_NSP} -o jsonpath="{.items[0].metadata.name}")

K8S_NSP="justice-archiver-dev"; \
K8S_POD=$(kubectl -n ${K8S_NSP} get pod -l app=${K8S_NSP} -o jsonpath="{.items[0].metadata.name}"); \

# open an interactive shell on an active pod
kubectl exec -it ${K8S_POD} -n ${K8S_NSP} -- bash

# monitor the system log of the first pod
kubectl logs -f ${K8S_POD} -n ${K8S_NSP}
````

Once you have an interactive shell, you can communicate with S3:

```bash
# list bucket directories
aws s3 ls s3://${S3_BUCKET_NAME}/

# get a list of snapshots
aws s3 ls s3://${S3_BUCKET_NAME}/www.justice.gov.uk/

# get a list of snapshot files - replace <date> 
aws s3 ls s3://${S3_BUCKET_NAME}/www.justice.gov.uk/<date>-03-00/ --recursive --human-readable
```

Copy a log file from a pod to your local machine
 
```bash
# change the date to 
# one that exists
SCRAPE_DATE="2023-10-24-18-03";

# requires K8S_NSP & K8S_POD 
# variables being defined  
kubectl -n ${K8S_NSP} cp ${K8S_POD}:/archiver/snapshots/www.justice.gov.uk/"${SCRAPE_DATE}"/hts-log.txt ~/hts-log.txt
```

<br><br> [back to top](#readme-top)
## Makefile

We use Makefile to reduce some complex or repetitive commands to simple `make` commands. 


### Make commands

| Command             | Description                                                                                                                                           |
| ------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| `make image`        | Used by GitHub action, cd.yml, during build step                                                                                                      |
| `make launch`       | Checks if the docker instance is running; if not, launch dory and docker in the background and open the site in the systems default browser           |
| `make run`          | Launch the application locally with `docker compose up`, requiring `env` + `dory`                                                                     |
| `make down`         | Alias of `docker compose down`.                                                                                                                       |
| `make shell`        | Open a bash shell on the spider container. The application must already be running (e.g. via `make run`) before this can be used.                     |
| `make sync` <img width="145" /> | Open a bash shell and execute `s3sync`. Uploads all assets to AWS S3                                                                      |
